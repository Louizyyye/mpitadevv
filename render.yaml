services:
  - type: web
    name: mpita-medical-api
    runtime: python
    repo: https://github.com/Louizyyye/mpitadevv
    branch: main
    plan: starter
    region: Nairobi

    buildCommand: pip install -r requirements.txt
    startCommand: uvicorn app.main:app --host 0.0.0.0 --port 8000

    autoDeploy: true

    envVars:
      - key: ENV
        value: production
      - key: DATABASE_URL
        fromDatabase:
          name: mpita-medical-db
          property: connectionString
      - key: SECRET_KEY
        generateValue: true
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: "60"
      - key: DEBUG
        value: "False"
      - fromGroup: mpita-env

    healthCheckPath: /docs

    scaling:
      minInstances: 1
      maxInstances: 3
      targetCPUPercent: 70
      targetMemoryPercent: 70

  - type: worker
    name: mpita-notification-worker
    runtime: python
    repo: https://github.com/Louizyyye/mpitadevv
    branch: main
    plan: starter
    buildCommand: pip install -r requirements.txt
    startCommand: python app/workers/notifications.py
    envVars:
      - fromGroup: mpita-env
      - key: DATABASE_URL
        fromDatabase:
          name: mpita-medical-db
          property: connectionString

  - type: cron
    name: mpita-db-backup
    runtime: python
    schedule: '0 0 * * *'
    repo: https://github.com/Louizyyye/mpitadevv
    buildCommand: pip install -r requirements.txt
    startCommand: python app/scripts/backup.py
    envVars:
      - fromGroup: mpita-env
      - key: DATABASE_URL
        fromDatabase:
          name: mpita-medical-db
          property: connectionString

  - type: web
    name: mpita-medical-docs
    runtime: static
    repo: https://github.com/Louizyyye/mpitadevv
    branch: main
    buildCommand: python generate_docs.py
    staticPublishPath: ./public
    headers:
      - path: /*
        name: X-Frame-Options
        value: sameorigin
    routes:
      - type: redirect
        source: /
        destination: /docs

databases:
  - name: mpita-medical-db
    plan: postgres-starter
    databaseName: mpita_medical
    user: mpita_admin
    ipAllowList:
      - source: 0.0.0.0/0
        description: open-access-for-render
    highAvailability:
      enabled: false

envVarGroups:
  - name: mpita-env
    envVars:
      - key: APP_NAME
        value: Mpita Medical System
      - key: EMAIL_SENDER
        value: no-reply@mpitahealth.com
      - key: LOG_LEVEL
        value: info
      - key: TIMEZONE
        value: Africa/Nairobi
      - key: MAX_CONNECTIONS
        value: "20"
      - key: REDIS_URL
        value: redis://default:password@localhost:6379/0
      - key: ENABLE_NOTIFICATIONS
        value: "true"
